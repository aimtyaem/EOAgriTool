<script>
    // Enhanced load modules with field integration
    const loadModules = {
        fields: () => {
            const data = JSON.parse(localStorage.getItem('fieldData')) || { fields: [] };
            return `
                <div class="card">
                    <h3 class="card-title">Field Status</h3>
                    ${data.fields.length > 0 ? 
                        data.fields.map(field => `
                            <div class="data-row">
                                <div>
                                    <span class="status-indicator ${field.health}"></span>
                                    ${field.name}
                                </div>
                                <div class="field-metrics">
                                    <span>${field.yield}</span>
                                    <small>${timeSince(field.lastUpdated)} ago</small>
                                </div>
                            </div>
                        `).join('') 
                        : '<div class="data-row">No fields registered yet</div>'
                    }
                </div>
            `;
        },
        // Keep other modules unchanged
    };

    // Add time formatting helper
    function timeSince(dateString) {
        const date = new Date(dateString);
        const seconds = Math.floor((new Date() - date) / 1000);
        const intervals = {
            year: 31536000,
            month: 2592000,
            day: 86400,
            hour: 3600,
            minute: 60
        };
        
        for (const [unit, secondsInUnit] of Object.entries(intervals)) {
            const interval = Math.floor(seconds / secondsInUnit);
            if (interval >= 1) {
                return `${interval} ${unit}${interval !== 1 ? 's' : ''}`;
            }
        }
        return 'just now';
    }

    // Enhanced initialization with real-time updates
    function initDashboard() {
        const dashboard = document.getElementById('dashboardMain');
        
        // Create refreshable card container
        dashboard.innerHTML = `
            <div id="cardsContainer">
                ${[
                    loadModules.fields(),
                    loadModules.climate(),
                    loadModules.water(),
                    loadModules.reports(),
                    loadModules.tutorials(),
                    `<div class="card expert-card">
                        <h3 class="card-title">üå± Expert Recommendations</h3>
                        ${getRecommendations()}
                    </div>`
                ].join('')}
            </div>
        `;
        
        // Add live update listeners
        window.addEventListener('storage', handleStorageUpdate);
    }

    // Handle real-time data updates
    function handleStorageUpdate(e) {
        if(e.key === 'fieldData') {
            const cardsContainer = document.getElementById('cardsContainer');
            cardsContainer.innerHTML = loadModules.fields();
        }
    }

    // Generate dynamic recommendations
    function getRecommendations() {
        const fields = JSON.parse(localStorage.getItem('fieldData'))?.fields || [];
        return fields.map(field => {
            if(field.health === 'poor') {
                return `<div class="data-row">‚ö†Ô∏è Check irrigation for ${field.name}</div>`;
            }
            if(field.health === 'fair') {
                return `<div class="data-row">üîç Monitor ${field.name} soil levels</div>`;
            }
            return '';
        }).join('') + '<div class="data-row">üìÖ Schedule weekly review</div>';
    }

    // Initialize with error handling
    document.addEventListener('DOMContentLoaded', () => {
        try {
            initDashboard();
            setInterval(() => {
                document.querySelectorAll('.data-row small').forEach(el => {
                    const timestamp = el.closest('.data-row').dataset.timestamp;
                    if(timestamp) el.textContent = timeSince(timestamp) + ' ago';
                });
            }, 60000); // Update timestamps every minute
        } catch (error) {
            console.error('Dashboard initialization failed:', error);
            document.getElementById('dashboardMain').innerHTML = `
                <div class="card">
                    <h3 class="card-title">‚ö†Ô∏è System Error</h3>
                    <div class="data-row">Please refresh the page</div>
                </div>
            `;
        }
    });
</script>